<!DOCTYPE html>
<html style="width: 100%; height: 100%; overflow: hidden">
  <head>
    <meta charset="utf-8">
    <title>Fiber Example</title>
  </head>
  <body>
    <div id="container">
      <p>
        To install React, follow the instructions on
        <a href="https://github.com/facebook/react/">GitHub</a>.
      </p>
      <p>
        If you can see this, React is <strong>not</strong> working right.
        If you checked out the source from GitHub make sure to run <code>grunt</code>.
      </p>
    </div>
    <script src="./react.js"></script>
    <script src="./react-dom-fiber.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.min.js"></script>

    <script type="text/babel">

    class Counter extends React.Component{
      constructor(props){
        super(props);
        this.state = {
          counter: Math.floor(Math.random() * (10 - 0)),
          operator: Math.random() < 0.5 ? 'minus' : 'plus',
        }
      }
      componentDidMount(){
        this.count = setInterval(this.count.bind(this), 1000);
      }
      count(){
        if(this.state.counter === 10){
          this.setState({ operator: 'minus'});
        } else if(this.state.counter === 0){
          this.setState({ operator: 'plus'});
        }

        if(this.state.operator === 'plus'){
          ReactDOMFiber.unstable_deferredUpdates(() =>
            this.setState({
              counter: this.state.counter += 1
            })
          );
        } else {
          ReactDOMFiber.unstable_deferredUpdates(() =>
            this.setState({
              counter: this.state.counter -= 1
            })
          );
        }
      }
      render() {
        return <div style={{ lineHeight: '3em' }}>{this.state.counter}</div>;
      }
    }

    class Node extends React.Component{
      constructor(props){
        super(props);
        this.state = {
          operator: Math.random() < 0.5 ? 'minus' : 'plus',
          xpos: Math.floor(Math.random() * (window.innerWidth - 0)),
          ypos: Math.floor(Math.random() * (window.innerHeight - 0))
        }
      }
      componentDidMount(){
        this.transition = setInterval(this.transition.bind(this), 10);
        this.direction = 'left';
      }
      transition(){
        if(this.direction === 'left'){
          if(this.state.xpos == 0){
            this.direction = 'right';
          } else {
            ReactDOMFiber.unstable_deferredUpdates(() =>
              this.setState({ xpos: this.state.xpos -= 1 })
            );
          }
        } else {
          // right
          if(this.state.xpos == window.innerWidth - 50){
            this.direction = 'left';
          } else {
            ReactDOMFiber.unstable_deferredUpdates(() =>
              this.setState({ xpos: this.state.xpos += 1 })
            );
          }
        }
      }
      render(){
        return(
          <div ref="node" style={{ position: 'absolute', top: this.state.ypos, left: this.state.xpos, background: 'blue', borderRadius: '40px', width: '50px', height: '50px', color: 'white', lineHeight: '1'}}>
            <Counter/>
          </div>
        )
      }
    }

    class App extends React.Component {

        render() {
          return (
            <div className="App">
              {Array.apply(null, {length: 300}).map(() =>
                <Node />
              )}
            </div>
          );
        }
      }

    function update(){
      ReactDOMFiber.render(
        <App />,
        document.getElementById('container')
      );
      requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
    </script>
